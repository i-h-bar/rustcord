name: Test Coverage

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Run tests with coverage
        run: cargo tarpaulin --out Xml --output-dir ./coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Generate coverage badge
        run: |
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1)
          COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc | cut -d. -f1)
          echo "Coverage: ${COVERAGE_PERCENT}%"

          # Create badge data
          if [ "$COVERAGE_PERCENT" -ge 80 ]; then
            COLOR="brightgreen"
          elif [ "$COVERAGE_PERCENT" -ge 60 ]; then
            COLOR="green"
          elif [ "$COVERAGE_PERCENT" -ge 40 ]; then
            COLOR="yellow"
          elif [ "$COVERAGE_PERCENT" -ge 20 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi

          echo "COVERAGE_PERCENT=${COVERAGE_PERCENT}" >> $GITHUB_ENV
          echo "COVERAGE_COLOR=${COLOR}" >> $GITHUB_ENV

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = process.env.COVERAGE_PERCENT;
            const color = process.env.COVERAGE_COLOR;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Test Coverage Report\n\n![Coverage](https://img.shields.io/badge/coverage-${coverage}%25-${color})\n\n**Test Coverage:** ${coverage}%`
            })

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      - name: Run tests
        run: cargo test --verbose

      - name: Count tests
        run: |
          TEST_COUNT=$(cargo test 2>&1 | grep -oP '\d+ passed' | head -1 | grep -oP '\d+')
          echo "TEST_COUNT=${TEST_COUNT}" >> $GITHUB_ENV
          echo "Found ${TEST_COUNT} passing tests"

      - name: Update README badge
        if: github.ref == 'refs/heads/main'
        run: |
          TEST_COUNT=$(cargo test 2>&1 | grep -oP '\d+ passed' | head -1 | grep -oP '\d+')
          sed -i "s/tests-[0-9]*%20passing/tests-${TEST_COUNT}%20passing/" README.md

          # Check if there are changes
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            echo "README.md updated with test count"
          fi
